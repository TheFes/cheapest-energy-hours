blueprint:
  name: Cheapest Energy Hours price sensor
  description: "# Cheapest Energy Hours price sensor

    This blueprint creates a sensor with a `prices` attribute which contains the prices
    from yesterday, today and tomorrow (if available). These prices can be used in the
    Cheapest Energy Hours macro.


    The blueprint can be used with the following integrations

    - Easy Energy

    - Energy Zero

    - Nordpool

    - Tibber


    The following inputs can be used in this blueprint:

    |input|default|description|

    |---|---|---|

    |`source`|`null`|The integration to be used as source, possible values are
    `easyenergy`, `energyzero`, `nordpool`, `tibber`|

    |`entity_id`|`sensor.cheapest_energy_hour_prices`|The entity id to be used for the template
    sensor|

    |`config_entry`|`null`|Required for Easy Energy, Energy Zero and Nordpool. To find it the
    easiest method is to go to Developer tools > Actions and use one of the actions provided
    by the integration in GUI mode, select the config entry and then switch to YAML mode|

    |`price_period`|`source`|The period in minutes to be used for the prices stored
    in the sensor. Possible values are `15`, `60` and `source`. This can be used to create
    hourly prices when the intgration provides prices per 15 minutes. By default it will use
    the same period as used in the source integration.|

    |`include_vat`|`false`|Only used for Easy Energy and Energy Zero. There is an option in
    the action to retreive the prices to include VAT. By default this is set to `false` as for
    Energy Zero this will result in prices rounded to 2 decimals. The `add_vat` input can be
    used to add VAT as well, but keep the precision.|

    |`add_vat`|`0`|VAT perecentage which will be added to the prices|

    |`add_fixed`|`0`|Can be used to add a fixed value to the prices. If you use the Nordpool
    integration you can use this to add the fixed uplift charged by your energy provider.|

    |`price_factor`|`1`|All prices will be multiplied with this value. This can be used for the
    Nordpool integration as prices are provided in MWh. You can use `0.001` to convert to kWh|


    Example:

    ```yaml

    template:

      - use_blueprint:

          path: TheFes/energy_price_sensor.yaml

          input:

            source: nordpool

            config_entry: 01K7YVVKK4RJ9SA25SZVS0AR19

            entity_id: sensor.nordpool_ceh_prices

            price_factor: 0.001

            add_vat: 21

            add_fixed: 0.0023

          name: Nordpool Cheapest Energy Hours

          unique_id: 881b6558-26c6-44bb-81c5-d86c05451bd4

    ```"
  author: TheFes
  source_url: https://github.com/TheFes/HA-configuration/blob/main/blueprints/template/TheFes/nordpool_hourly.yaml
  domain: template
  input:
    source:
      name: Source integration
      description: The source integration used to provide the data
      selector:
        select:
          options:
            - label: EasyEnergy
              value: easyenergy
            - label: EnergyZero
              value: energyzero
            - label: NordPool
              value: nordpool
            - label: Tibber
              value: tibber
    entity_id:
      name: Entity id for template sensor
      description: The entity_id which will be used for the template sensor created using this blueprint
      selector:
        text:
          multiple: false
          multiline: false
      default: sensor.cheapest_energy_hour_prices
    config_entry:
      name: The config entry id for the integration.
      description: This is not required for Tibber, but for all other source integrations it is a required field
      selector:
        config_entry:
      default: null
    resolution:
      name: Resolution time
      description: >
        The resolution used for the output of the price data for the Nordpool integration in minutes.
        This can be used to force the output to hourly prices. Possible values are 15, 30 and 60.
        By default 15 minutes will be used, this will also be used if a value other than 15, 30 or
        60 is set.
      selector:
        number:
          min: 15
          max: 60
          step: 15
          mode: box
          unit_of_measurement: min
      default: 15
    include_vat:
      name: Include VAT in prices
      description:
        Only used for EasyEnergy and EnergyZero. Note that for EnergyZero this the prices will be rounded to 2
        decimal precision if include VAT is enabled.
      default: false
    add_vat:
      name: VAT % to add to the prices
      description: Set a percentage here if you want to add VAT to the prices provided by the source integration
      selector:
        number:
          min: 0
          max: 100
          step: "any"
          unit_of_measurement: "%"
          mode: "box"
      default: 0
    add_fixed:
      name:
        Fixed value to be added to prices. Can be used to e.g. add a fixed price for your energy provided in
        case you use Nordpool as the source. This fixed value should already include VAT if applicable.
      selector:
        number:
          step: "any"
          mode: "box"
      default: 0
    price_factor:
      name: Price Factor
      description:
        Value which will be used to multiply the prices with. If the source integration e.g. provides the prices
        in cents, but you want them in EUR, you can use 0.01 as price factor.
        By default 1 is used, only for Nordpool the default is 0.001 as the integration provides the prices in MWh.
      selector:
        number:
          step: "any"
          mode: "box"
      default: null

variables:
  entity_id: !input entity_id
  resolution: !input resolution
  source: !input source
  config_entry_input: !input config_entry
  config_entry: >
    {{ config_entry
        | default(integration_entities(source)
          | first
          | default
          | config_entry_id, true)
    }}
  include_vat: !input include_vat
  price_factor_input: !input price_factor
  price_factor: "{{ price_factor_input | default(0.001 if source == 'nordpool' else 1, true) }}"
  add_vat: !input add_vat
  add_fixed: !input add_fixed
  old_prices: "{{ state_attr(entity_id, 'prices') | default([], true) }}"
  fetch: >
    {% set yesterday = old_prices 
        | selectattr('start', 'search', (now().date()-timedelta(days=1)).isoformat())
        | list
        | count < 23
        or trigger.id == 'event' %}
    {% set today = old_prices 
        | selectattr('start', 'search', now().date().isoformat())
        | list
        | count < 23
        or trigger.id == 'event' %}
    {% set tomorrow = (old_prices 
        | selectattr('start', 'search', (now().date()+timedelta(days=1)).isoformat())
        | list
        | count < 23 
        and now() > today_at('13:00'))
        or trigger.id =='event' %}
    {{ dict(yesterday=yesterday, today=today, tomorrow=tomorrow) }}
  should_fetch: >
    {{ fetch.yesterday or fetch.today or fetch.tomorrow }}
  mapping:
    easyenergy:
      time_key: timestamp
      value_key: price
    energyzero:
      time_key: timestamp
      value_key: price
    nordpool:
      time_key: start
      value_key: price
    tibber:
      time_key: start_time
      value_key: price

triggers:
  - alias: Triggers every 15 minutes
    trigger: time_pattern
    minutes: "/15"
  - alias: Triggers on home assistant startup
    trigger: homeassistant
    event: start
  - alias: Custom event to update prices
    trigger: event
    event_type: update_ceh_prices
    id: event

actions:
  - alias: "Fetch new prices if needed"
    if: "{{ should_fetch }}"
    then:
      - alias: Short delay to avoid everyone calling the API at the same time
        delay:
          seconds: "{{ range(0, 15) | random }}"
      - choose:
          - conditions: "{{ source in ['easyenergy', 'energyzero'] }}"
            sequence:
              - alias: Collects the price information and stores this in a response variable
                action: >
                  {{
                    'easyenergy.get_energy_usage_prices'
                    if source == 'easyenergy'
                    else 'energyzero.get_energy_prices'
                  }}
                data:
                  incl_vat: "{{ include_vat }}"
                  config_entry: "{{ config_entry }}"
                  start: >
                    {% if fetch.yesterday %}
                      {% set delta = -1 %}
                    {% elif fetch.today %}
                      {% set delta = 0 %}
                    {% else %}
                      {% set delta = 1 %}
                    {% endif %}
                    {{ today_at() + timedelta(days=delta) }}
                  end: >
                    {% if fetch.tomorrow %}
                      {% set delta = 2 %}
                    {% elif fetch.today %}
                      {% set delta = 1 %}
                    {% else %}
                      {% set delta = 0 %}
                    {% endif %}
                    {{ today_at() + timedelta(days=delta) }}
                    {{ today_at() + timedelta(days=delta) }}
                response_variable: prices
                continue_on_error: true
              - variables:
                  prices: "{{ prices.prices if prices is defined else [] }}"
          - conditions: "{{ source == 'tibber' }}"
            sequence:
              - alias: "Fetch the prices for yesterday, today and tomorrow"
                action: tibber.get_prices
                data:
                  start: >
                    {% if fetch.yesterday %}
                      {% set delta = -1 %}
                    {% elif fetch.today %}
                      {% set delta = 0 %}
                    {% else %}
                      {% set delta = 1 %}
                    {% endif %}
                    {{ (today_at('00:00') - timedelta(days=delta)).strftime('%Y-%m-%d %H:%M:%S') }}
                  end: >
                    {% if fetch.tomorrow %}
                      {% set delta = 2 %}
                    {% elif fetch.today %}
                      {% set delta = 1 %}
                    {% else %}
                      {% set delta = 0 %}
                    {% endif %}
                    {{ (today_at('00:00') + timedelta(days=delta)).strftime('%Y-%m-%d %H:%M:%S') }}
                response_variable: prices
              - variables:
                  prices: "{{ prices.prices.values() | first | default([], true) }}"
          - conditions: "{{ source == 'nordpool' }}"
            sequence:
              - sequence:
                  - if: "{{ fetch.yesterday }}"
                    then:
                      - action: nordpool.get_price_indices_for_date
                        data:
                          config_entry: "{{ config_entry}}"
                          date: "{{ now().date() - timedelta(days=1) }}"
                          resolution: "{{ resolution }}"
                        response_variable: yesterday
                      - variables:
                          yesterday: "{{ yesterday.values() | first }}"
                  - if: "{{ fetch.today }}"
                    then:
                      - action: nordpool.get_price_indices_for_date
                        data:
                          config_entry: "{{ config_entry}}"
                          date: "{{ now().date() }}"
                          resolution: "{{ resolution }}"
                        response_variable: today
                      - variables:
                          today: "{{ today.values() | first }}"
                  - if: "{{ fetch.tomorrow }}"
                    then:
                      - action: nordpool.get_price_indices_for_date
                        data:
                          config_entry: "{{ config_entry}}"
                          date: "{{ now().date() + timedelta(days=1) }}"
                          resolution: "{{ resolution }}"
                        response_variable: tomorrow
                      - variables:
                          tomorrow: "{{ tomorrow.values() | first }}"
              - variables:
                  prices: "{{ [yesterday, today, tomorrow] | select('defined') | flatten(1) }}"
      - alias: Update result to generic format and apply VAT and fixed price if needed
        variables:
          new_prices: >
            {% set time_key = mapping[source].time_key %}
            {% set value_key = mapping[source].value_key %}
            {% set ns = namespace(prices=[]) %}
              {% set t = (price[time_key] | as_datetime | as_local).isoformat() %}
              {% set p = price[value_key] * price_factor * (1 + add_vat / 100) + add_fixed %}
              {% set ns.prices = ns.prices + [dict(start=t, price=p | round(5))] %}
            {% endfor %}
            {{ ns.prices }}
  - alias: "Set variables to be used in sensor"
    variables:
      updated_prices: >
        {{
          (old_prices
            | selectattr('start', '>=', (today_at('00:00') - timedelta(days=1)).isoformat())
            | list + new_prices)
              | unique(attribute='start')
              | list
              | sort(attribute='start')
        }}
      fetch_time: "{{ now() if should_fetch else state_attr(entity_id, 'last_fetch_time') }}"
      prices_today: >
        {{
          updated_prices
            | selectattr('start', 'search', now().date().isoformat())
            | map(attribute='price')
            | list
        }}

sensor:
  default_entity_id: !input entity_id
  icon: mdi:currency-eur
  unit_of_measurement: EUR/kWh
  state_class: measurement
  state: >
    {% set price = updated_prices | map(attribute='price') | list %}
    {% set time = updated_prices | map(attribute='start') | map('as_datetime') | list %}
    {{ zip(price, time) | selectattr('1', '<=', now()) | map(attribute='0') | list | last }}
  attributes:
    prices: "{{ updated_prices }}"
    last_fetch_time: "{{ fetch_time }}"
  availability: "{{ prices_today | count >= 23 }}"
